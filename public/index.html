<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ūdens skaitītāju rādījumu iesniegšana</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --border:#d8dde3;
      --muted:#6b7280;
      --blue:#1f5f86;
      --danger:#b00020;
      --radius:14px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    body{ background:var(--bg); margin:0; padding:24px; color:#111; }
    .wrap{ max-width:980px; margin:0 auto; }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    h1{ margin:0 0 14px; font-size:20px; font-weight:900; }
    .section-title{ font-size:14px; font-weight:900; margin:14px 0 8px; color:#1b1b1b; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; position:relative; }
    label{ font-size:13px; color:#222; font-weight:800; }

    input, button{ font:inherit; }
    input[type="text"]{
      border:2px solid #cfd6de;
      border-radius:var(--radius);
      padding:12px 12px;
      background:#fff;
      outline:none;
      transition:border-color .15s ease;
      width:100%;
    }
    input:focus{ border-color:var(--blue); }
    input[readonly], input:disabled{ background:#f3f5f8; color:#111; }

    .hint{ font-size:12px; color:#666; margin-top:-2px; }
    .error{ font-size:12px; color:var(--danger); display:none; }
    .error.show{ display:block; }

    .noticeBox{
      margin:0 0 12px;
      border:1px solid #f0c9cf;
      background:#fff5f7;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      color:#7a0016;
      display:none;
    }
    .noticeBox.show{ display:block; }

    .lookupBox{
      margin:0 0 12px;
      border:1px solid #cfd6de;
      background:#f7fafc;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      color:#1b1b1b;
      display:none;
    }
    .lookupBox.show{ display:block; }
    .lookupBox.loading{ opacity:.85; }
    .lookupBox.good{ border-color:#cfe8d6; background:#f3fff6; }
    .lookupBox.bad{ border-color:#f0c9cf; background:#fff5f7; color:#7a0016; }

    /* palīdzības rinda: teksts + sarkans ? */
    .helpRow{ display:flex; align-items:center; gap:10px; margin-top:6px; }
    .helpLink{
      font-size:13px; font-weight:900; color:var(--blue);
      cursor:pointer; user-select:none;
    }
    .helpLink:hover{ text-decoration:underline; }
    .helpQ{
      width:34px; height:34px; border-radius:999px;
      border:none; background:var(--danger); color:#fff;
      font-weight:1000; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      box-shadow:0 6px 18px rgba(176,0,32,.25);
    }
    .helpQ:active{ transform:translateY(1px); }

    /* 8 ciparu lauki */
    .code-boxes{ display:flex; gap:8px; width:fit-content; max-width:100%; overflow:hidden; }
    .code-boxes input{
      width:40px;height:46px;flex:0 0 40px;
      text-align:center;font-size:18px;font-weight:900;
      border-radius:12px;border:2px solid #cfd6de;padding:0;
    }
    @media (max-width:520px){
      .code-boxes{ width:100%; display:grid; grid-template-columns:repeat(8, minmax(0,1fr)); gap:6px; }
      .code-boxes input{ width:100%; height:44px; font-size:16px; }
    }

    .btn-row{ display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
    .btn-secondary{
      border-radius:14px; border:2px solid #cfd6de; background:#fff;
      padding:12px 14px; cursor:pointer; font-weight:900;
    }
    .btn-secondary:hover{ background:#eef3f8; }

    .btn-primary{
      border-radius:14px; border:none; background:var(--blue); color:#fff;
      padding:14px 18px; cursor:pointer; font-weight:1000; width:100%; margin-top:14px;
    }
    .btn-primary.disabled{ opacity:.55; cursor:not-allowed; }

    .address-block{
      border:2px solid #e3e7ec;
      border-radius:18px;
      padding:14px;
      margin-top:12px;
      background:#fff;
      position:relative;
    }
    .address-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .auto-address-title{ font-size:13px; font-weight:1000; color:#111; padding-top:2px; }

    .meters{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }

    /* manual meter row */
    .meter-row{
      display:grid;
      grid-template-columns: 1fr 1fr 56px;
      gap:10px;
      align-items:end;
    }
    .meterNrField{ grid-column:1; }
    .readingField{ grid-column:2; }
    .delCell{ grid-column:3; display:flex; justify-content:flex-end; align-items:flex-end; }
    .del-btn{
      width:42px;height:42px;border-radius:12px;border:2px solid #f0c9cf;
      background:#fff;color:var(--danger);cursor:pointer;font-weight:1000;
    }
    .del-btn.hidden{ display:none; }

    .btn-add-meter{
      border-radius:12px;border:2px dashed #cfd6de;background:#f9fbfd;
      padding:10px 14px;font-weight:900;color:#1976d2;cursor:pointer;width:fit-content;margin-top:8px;
    }
    .btn-add-meter:hover{ background:#eef3f8; }

    @media (max-width:640px){
      .meter-row{ grid-template-columns: 1fr; grid-template-rows:auto auto auto; }
      .delCell{ justify-content:stretch; }
      .del-btn{ width:100%; height:auto; padding:12px 14px; border-radius:14px; }
      .del-btn span{ display:none; }
      .del-btn::before{ content:"Dzēst skaitītāju"; }
      .address-head{ flex-direction:column; align-items:stretch; gap:8px; }
    }

    /* autocomplete */
    .suggestions{
      position:absolute; top:100%; left:0; right:0;
      background:#fff; border:1px solid var(--border); border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.12);
      overflow:hidden; z-index:50; margin-top:6px;
      display:none; max-height:320px; overflow-y:auto;
    }
    .suggestions.show{ display:block; }
    .sitem{
      width:100%; text-align:left; padding:10px 12px; background:#fff; border:none;
      cursor:pointer; font-size:13px; line-height:1.25;
    }
    .sitem:hover{ background:#eef3f8; }

    .infoBox{
      margin-top:10px;border:1px solid #f0c9cf;background:#fff5f7;border-radius:14px;
      padding:10px 12px;font-size:13px;color:#7a0016;display:none;
    }
    .infoBox.show{ display:block; }

    /* AUTO */
    #autoSection{ display:none; margin-top:10px; }

    .auto-meter-row{
      display:grid;
      grid-template-columns: 170px 170px 220px 140px 54px; /* pēdējā ikonai */
      gap:10px;
      align-items:end;
      margin-top:10px;
    }
    .auto-meter-row.neg input[data-role="cons"]{ color:var(--danger); font-weight:1000; }

    /* kompaktāki ievades lauki auto režīmā */
    #autoSection input[type="text"]{ padding:10px 10px; }
    #autoSection label{ font-size:12px; }

    @media (max-width:640px){
      .auto-meter-row{ grid-template-columns: 1fr; }
    }

    /* vēstures ikona aizpilda visu kvadrātu */
    .histIconBtn{
      width:44px;
      height:44px;
      border-radius:12px;
      border:2px solid #cfd6de;
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:0;
    }
    .histIconBtn:hover{ background:#eef3f8; }
    .histIconBtn img{
      width:100%;
      height:100%;
      padding:0;           /* lielāka ikona, bez “sīka” efekta */
      object-fit:cover;
	  border-radius:10px;
      display:block;
    }

    .historyCell{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
    }
    .historyCell label{
      opacity:0;
      height:16px;
    }

    /* modals */
    #submitModal, #notFoundModal, #helpModal, #historyModal { position: fixed; inset: 0; z-index: 9999; display:none; }
    .modalBackdrop { position: absolute; inset: 0; background: rgba(0,0,0,.35); }
    .modalCard{
      position:absolute; left:50%; top:50%; transform: translate(-50%,-50%);
      width:min(560px, calc(100vw - 32px));
      background:#fff; border:1px solid #e5e7eb; border-radius:16px;
      padding:16px; box-shadow: 0 18px 50px rgba(0,0,0,.18);
    }
    .modalTitle{ font-weight:900; font-size:16px; margin:0 0 8px; }
    .modalText{ font-size:14px; color:#333; margin:0 0 12px; }
    .modalActions{ display:flex; gap:10px; justify-content:flex-end; }
    .btn-outline{
      border-radius:12px; padding:10px 12px; font-weight:900; cursor:pointer;
      border:2px solid #cfd6de; background:#fff;
    }
    .btn-outline.primary{ border-color: var(--blue); color: var(--blue); }
    .btn-outline.danger{ border-color: var(--danger); color: var(--danger); }

    #helpImg{ width:100%; height:auto; border-radius:12px; border:1px solid #e5e7eb; display:block; }

    /* history */
    #histCanvas{ width:100%; height:240px; border:1px solid #eee; border-radius:14px; }
    #histMeta{ font-size:12px; color:#666; margin-top:8px; }
    #histLoading{ font-size:13px; color:#333; margin-bottom:10px; }

    #manualSection{ display:none; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Ūdens skaitītāju rādījumu iesniegšana</h1>

    <div id="windowNotice" class="noticeBox"></div>
    <div id="lookupNotice" class="lookupBox"></div>

    <div class="section-title">Abonenta informācija</div>

    <div class="field">
      <label>Abonenta kods (8 cipari)</label>
      <div class="code-boxes" id="abonentaCodeBoxes"></div>
      <div class="helpRow">
        <div class="helpLink" id="helpLink1">Kur to atrast rēķinā?</div>
        <button type="button" class="helpQ" id="helpBtn1" aria-label="Palīdzība">?</button>
      </div>
      <div class="error" id="errAbonents">Abonenta kodam jābūt 8 cipariem.</div>
    </div>

    <div class="field">
      <label>Līguma numurs</label>
      <input id="contractNr" type="text" autocomplete="off" placeholder="Ievadi līguma numuru" />
      <div class="helpRow">
        <div class="helpLink" id="helpLink2">Kur to atrast rēķinā?</div>
        <button type="button" class="helpQ" id="helpBtn2" aria-label="Palīdzība">?</button>
      </div>
      <div class="error" id="errContract">Lūdzu ievadi līguma numuru.</div>
    </div>

    <div class="btn-row">
      <button class="btn-secondary" id="lookupBtn" type="button">IEVADĪT</button>
    </div>

    <div id="autoSection">
      <div class="section-title">Skaitītāji</div>
      <div id="autoAddresses"></div>
    </div>

    <div id="manualSection">
      <div class="section-title">Adreses un skaitītāji</div>
      <div id="addresses"></div>
      <div class="btn-row">
        <button class="btn-secondary" id="addAddressBtn" type="button">+ Pievienot adresi</button>
      </div>
    </div>

    <!-- SĀKUMĀ SLĒPTS: parādās tikai pēc lookup/manual -->
    <button class="btn-primary disabled" id="submitBtn" type="button" aria-disabled="true" style="display:none;">IESNIEGT</button>
    <div id="submitInfo" class="infoBox"></div>
  </div>
</div>

<!-- Submit popup -->
<div id="submitModal">
  <div class="modalBackdrop" id="submitBackdrop"></div>
  <div class="modalCard" id="submitCard" role="dialog" aria-modal="true">
    <div class="modalTitle" id="submitTitle">SŪTU…</div>
    <div class="modalText" id="submitText">Lūdzu uzgaidi, notiek rādījumu nosūtīšana.</div>
    <div class="modalActions">
      <button type="button" class="btn-outline primary" id="submitCloseBtn" style="display:none;">AIZVĒRT</button>
      <button type="button" class="btn-outline danger" id="submitRetryBtn" style="display:none;">MĒĢINĀT VĒLREIZ</button>
    </div>
  </div>
</div>

<!-- Lookup not found modal -->
<div id="notFoundModal">
  <div class="modalBackdrop" id="notFoundBackdrop"></div>
  <div class="modalCard" id="notFoundCard" role="dialog" aria-modal="true">
    <div class="modalTitle">Klients netika atrasts</div>
    <div class="modalText">
      Pārbaudiet abonenta kodu un līguma numuru. Ja nevarat atrast datus rēķinā, ievadiet rādījumus manuāli.
    </div>
    <div class="modalActions">
      <button type="button" class="btn-outline primary" id="notFoundEditBtn">Labot</button>
      <button type="button" class="btn-outline danger" id="notFoundManualBtn">Ievadīt manuāli</button>
    </div>
  </div>
</div>

<!-- Help modal -->
<div id="helpModal">
  <div class="modalBackdrop" id="helpBackdrop"></div>
  <div class="modalCard" id="helpCard" role="dialog" aria-modal="true">
    <div class="modalTitle">Kur atrast abonenta kodu un līguma numuru?</div>
    <div class="modalText">Abonenta kods un līguma numurs ir norādīts rēķina augšējā labajā stūrī.</div>
    <img id="helpImg" src="/assets/rekins-paraugs.png" alt="Rēķina fragments" />
    <div class="modalActions" style="margin-top:12px;">
      <button type="button" class="btn-outline primary" id="helpCloseBtn">AIZVĒRT</button>
    </div>
  </div>
</div>

<!-- History modal -->
<div id="historyModal">
  <div class="modalBackdrop" id="histBackdrop"></div>
  <div class="modalCard" id="histCard" role="dialog" aria-modal="true">
    <div class="modalTitle" id="histTitle">Patēriņš pa mēnešiem (m³)</div>
    <div id="histLoading">Ielādēju…</div>
    <canvas id="histCanvas" width="900" height="280"></canvas>
    <div id="histMeta"></div>
    <div class="modalActions" style="margin-top:12px;">
      <button type="button" class="btn-outline primary" id="histCloseBtn">AIZVĒRT</button>
    </div>
  </div>
</div>

<script>
  const CFG = {
    abonRegex: /^\d{8}$/,
    meterNrRegex: /^\d+$/,
    readingRegex: /^\d+([.]\d{1,2})?$/,
    addrMinChars: 1,
    addrLimit: 12,
    meterDeleteShownFromIndex: 1
  };

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function el(tag, attrs={}, children=[]) {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs)) {
      if (k === "class") n.className = v;
      else if (k === "text") n.textContent = v;
      else if (k === "value") n.value = v;
      else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, v);
    }
    children.forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
    return n;
  }

  function setLookupNotice(type, html){
    const box = $("#lookupNotice");
    box.classList.remove("show","loading","good","bad");
    if (!html) { box.innerHTML=""; return; }
    box.innerHTML = html;
    box.classList.add("show");
    if (type) box.classList.add(type);
  }

  function normalizeReadingInput(raw) {
    let s = String(raw || '').trim().replace(',', '.');
    s = s.replace(/[^\d.]/g, '');
    const firstDot = s.indexOf('.');
    if (firstDot !== -1) {
      s = s.slice(0, firstDot + 1) + s.slice(firstDot + 1).replace(/\./g, '');
      const parts = s.split('.');
      s = parts[0] + '.' + (parts[1] || '').slice(0, 2);
    }
    return s;
  }

  function parseReading(v){
    const s = String(v || '').trim().replace(',', '.');
    if (!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  // ===== State =====
  let MODE = "lookup";
  let LOOKUP_LOADING = false;
  let LOOKUP_FOUND = false;
  let LOOKUP_ATTEMPTED = false;

  // UX flags: show field errors only after user interaction or lookup attempt
  let CONTRACT_TOUCHED = false;
  let ABON_TOUCHED = false;

  // Invite mode
  let INVITE_MODE = false;
  let INVITE_TOKEN = '';
  let INVITE_SUBSCRIBER = '';
  let INVITE_ALL_LOCKED = false;


  function setSubmitVisible(isVisible){
    const btn = $("#submitBtn");
    btn.style.display = isVisible ? "block" : "none";
    if (!isVisible) {
      $("#submitInfo").classList.remove("show");
      $("#submitInfo").innerHTML = "";
    }
  }

  // ===== modal helpers =====
  function showModal(id){ $(id).style.display='block'; }
  function hideModal(id){ $(id).style.display='none'; }

  // submit modal
  let MODAL_LAST_STATE = "idle";
  function modalStateSending() {
    MODAL_LAST_STATE="sending";
    showModal('#submitModal');
    $('#submitTitle').textContent='SŪTU…';
    $('#submitText').textContent='Lūdzu uzgaidi, notiek rādījumu nosūtīšana.';
    $('#submitCloseBtn').style.display='none';
    $('#submitRetryBtn').style.display='none';
  }
  function modalStateSuccess() {
    MODAL_LAST_STATE="success";
    showModal('#submitModal');
    $('#submitTitle').textContent='RĀDĪJUMS IESNIEGTS';
    $('#submitText').textContent='Paldies! Jūsu rādījumi ir saņemti.';
    $('#submitCloseBtn').style.display='inline-block';
    $('#submitRetryBtn').style.display='none';
  }
  function modalStateError(errText) {
    MODAL_LAST_STATE="error";
    showModal('#submitModal');
    $('#submitTitle').textContent='KĻŪDA';
    $('#submitText').textContent=errText || 'Neizdevās nosūtīt.';
    $('#submitCloseBtn').style.display='inline-block';
    $('#submitRetryBtn').style.display='inline-block';
  }
  $('#submitBackdrop').addEventListener('click', () => { hideModal('#submitModal'); if (MODAL_LAST_STATE==="success" && !INVITE_MODE) resetFormAll(); });
  $('#submitCloseBtn').addEventListener('click', () => { hideModal('#submitModal'); if (MODAL_LAST_STATE==="success" && !INVITE_MODE) resetFormAll(); });
  $('#submitRetryBtn').addEventListener('click', () => { hideModal('#submitModal'); refreshAll(); });

  // not found modal
  $('#notFoundBackdrop').addEventListener('click', () => hideModal('#notFoundModal'));
  $('#notFoundEditBtn').addEventListener('click', () => { hideModal('#notFoundModal'); $('#contractNr').focus(); });
  $('#notFoundManualBtn').addEventListener('click', () => { hideModal('#notFoundModal'); switchToManual(); });

  // help modal
  function openHelp(){ showModal('#helpModal'); }
  $('#helpBackdrop').addEventListener('click', () => hideModal('#helpModal'));
  $('#helpCloseBtn').addEventListener('click', () => hideModal('#helpModal'));
  $('#helpBtn1').addEventListener('click', openHelp);
  $('#helpBtn2').addEventListener('click', openHelp);
  $('#helpLink1').addEventListener('click', openHelp);
  $('#helpLink2').addEventListener('click', openHelp);

  // history modal
  $('#histBackdrop').addEventListener('click', () => hideModal('#historyModal'));
  $('#histCloseBtn').addEventListener('click', () => hideModal('#historyModal'));
  $('#histCard').addEventListener('click', (e) => e.stopPropagation());

  async function refreshWindowNotice() {
    const box = $("#windowNotice");
    try {
      const res = await fetch("/api/window");
      const w = await res.json();
      if (!w.is_open && w.enforce) {
        box.innerHTML = "<b>Rādījumu iesniegšana no 25.datuma līdz mēneša beigām.</b>";
        box.classList.add("show");
      } else if (!w.enforce) {
        box.innerHTML = "<b>TESTA vide:</b> iesniegšana nav ierobežota pēc datuma.";
        box.classList.add("show");
      } else {
        box.classList.remove("show");
        box.innerHTML = "";
      }
    } catch {
      box.classList.remove("show");
      box.innerHTML = "";
    }
  }

  function initCodeBoxes() {
    const host = $("#abonentaCodeBoxes");
    host.innerHTML = "";
    for (let i=0; i<8; i++) {
      const inp = el("input", { type:"text", inputmode:"numeric", maxlength:"1", "aria-label":`Cipars ${i+1}` });

      inp.addEventListener("input", () => {
        ABON_TOUCHED = true;
        inp.value = inp.value.replace(/\D/g, "").slice(0,1);
        if (inp.value && i < 7) host.children[i+1].focus();

        if (MODE === "lookup") {
          LOOKUP_FOUND = false; LOOKUP_ATTEMPTED = false; LOOKUP_LOADING = false;
          setLookupNotice(null, ""); clearAuto();
        }
        refreshAll();
      });

      inp.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !inp.value && i > 0) host.children[i-1].focus();
      });

      inp.addEventListener("paste", (e) => {
        ABON_TOUCHED = true;
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData("text");
        const digits = (text || "").replace(/\D/g, "").slice(0,8);
        for (let j=0; j<8; j++) host.children[j].value = digits[j] || "";
        (host.children[Math.min(digits.length,7)] || host.children[7]).focus();

        if (MODE === "lookup") {
          LOOKUP_FOUND = false; LOOKUP_ATTEMPTED = false; LOOKUP_LOADING = false;
          setLookupNotice(null, ""); clearAuto();
        }
        refreshAll();
      });

      host.appendChild(inp);
    }
  }

  function readAbonentaKods() { return $$("#abonentaCodeBoxes input").map(i => i.value.trim()).join(""); }
  function readContractNr() { return String($("#contractNr").value || "").trim(); }

  // ===== AUTO rendering =====
  function clearAuto(){
    $("#autoAddresses").innerHTML = "";
    $("#autoSection").style.display = "none";
    if (MODE === "lookup") setSubmitVisible(false);
  }

  function drawHistoryChart(canvas, items) {
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    const padL=48, padR=12, padT=16, padB=36;
    const iw = w - padL - padR;
    const ih = h - padT - padB;

    const values = items.map(x => Number(x.m3) || 0);
    const labels = items.map(x => String(x.month || '').slice(5,7)); // MM
    const maxV = Math.max(1, ...values);

    ctx.strokeStyle = '#ddd';
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT+ih);
    ctx.lineTo(padL+iw, padT+ih);
    ctx.stroke();

    const n = values.length || 1;
    const bw = iw / n;

    ctx.fillStyle = '#1f5f86';
    for (let i=0;i<n;i++){
      const v = values[i];
      const bh = (v/maxV)*ih;
      const x = padL + i*bw + 3;
      const y = padT + ih - bh;
      ctx.fillRect(x, y, Math.max(2, bw-6), bh);

      ctx.fillStyle = '#111';
      ctx.font = '12px system-ui';
      const t = (Math.round(v*100)/100).toFixed(2).replace(/\.00$/,'');
      ctx.fillText(t, x, Math.max(padT+12, y-4));
      ctx.fillStyle = '#1f5f86';
    }

    ctx.fillStyle = '#555';
    ctx.font = '12px system-ui';
    ctx.fillText('0', 12, padT+ih);
    ctx.fillText(String(maxV), 12, padT+12);

    ctx.fillStyle = '#555';
    ctx.font = '12px system-ui';
    for (let i=0;i<n;i++){
      const x = padL + i*bw + 6;
      ctx.fillText(labels[i], x, padT+ih+20);
    }
  }

  async function openHistory(address, contract, meter) {
    const subscriber = (typeof INVITE_SUBSCRIBER !== 'undefined' && INVITE_SUBSCRIBER) ? INVITE_SUBSCRIBER : readAbonentaKods();
    if (!CFG.abonRegex.test(subscriber) || !contract || !meter) return;

    $('#histTitle').textContent = `Patēriņš pa mēnešiem (m³) — Skaitītājs ${meter}`;
    $('#histLoading').textContent = 'Ielādēju…';
    $('#histMeta').textContent = address ? address : '';
    showModal('#historyModal');

    try {
      const res = await fetch(`/api/history?subscriber=${encodeURIComponent(subscriber)}&contract=${encodeURIComponent(contract)}&meter=${encodeURIComponent(meter)}`);
      const j = await res.json().catch(()=>null);
      if (!res.ok || !j || j.ok !== true) {
        $('#histLoading').textContent = 'Neizdevās ielādēt vēsturi.';
        return;
      }

      const items = Array.isArray(j.items) ? j.items : [];
      const fixed = items.map(x => ({
        month: x.month,
        m3: (Number(x.m3) > 0 && Number.isFinite(Number(x.m3))) ? Number(x.m3) : 0
      }));

      if (!fixed.length) {
        $('#histLoading').textContent = 'Vēsturiskie dati nav atrasti.';
        drawHistoryChart($('#histCanvas'), Array.from({length:12}, ()=>({month:'', m3:0})));
        return;
      }

      $('#histLoading').textContent = '';
      drawHistoryChart($('#histCanvas'), fixed);

      const total = fixed.reduce((a,b)=>a+(Number(b.m3)||0),0);
      $('#histMeta').textContent = `${address || ''} • Pēdējie 12 mēneši • Kopā: ${total.toFixed(2).replace(/\.00$/,'')} m³`;
    } catch {
      $('#histLoading').textContent = 'Neizdevās ielādēt vēsturi.';
    }
  }

  function renderAuto(addresses){
    const host = $("#autoAddresses");
    host.innerHTML = "";

    function computeFromNew(row) {
      const lastEl = $("input[data-role='last']", row);
      const newEl = $("input[data-role='new']", row);
      const consEl = $("input[data-role='cons']", row);

      const prev = parseReading(lastEl.value);
      const cur = parseReading(newEl.value);

      if (prev == null || cur == null) {
        if (!String(newEl.value || '').trim()) consEl.value = "";
        row.classList.remove("neg");
        return;
      }

      const diff = cur - prev;
      consEl.value = diff.toFixed(2);
      row.classList.toggle("neg", diff < 0);
    }

    function computeFromCons(row) {
      const lastEl = $("input[data-role='last']", row);
      const newEl = $("input[data-role='new']", row);
      const consEl = $("input[data-role='cons']", row);

      const prev = parseReading(lastEl.value);
      const cons = parseReading(consEl.value);

      if (prev == null || cons == null) return;

      const cur = prev + cons;
      newEl.value = cur.toFixed(2);
      row.classList.toggle("neg", (cur - prev) < 0);
    }

    addresses.forEach((a) => {
      const addrText = String(a.address || "").trim();
      const meters = Array.isArray(a.meters) ? a.meters : [];

      const block = el("div", { class:"address-block" });

      const head = el("div", { class:"address-head" }, [
        el("div", { class:"auto-address-title", text: addrText })
      ]);

      const metersHost = el("div", { class:"meters" });

      meters.forEach((m) => {
        const meter = String(m.meter_serial || "").trim();
        const last = (m.last_reading == null) ? "" : String(m.last_reading);
        const cNr = String(m.contract_nr || "").trim();

        const row = el("div", { class:"auto-meter-row", "data-meter": meter, "data-contract": cNr });

        const f1 = el("div", { class:"field" }, [
          el("label", { text:"Skaitītāja Nr" }),
          el("input", { type:"text", readonly:"true", value: meter }),
          cNr ? el("div", { class:"hint", text:`Līgums: ${cNr}` }) : el("div", { class:"hint", text:"" })
        ]);

        const f2 = el("div", { class:"field" }, [
          el("label", { text:"Pēdējais rādījums" }),
          el("input", { type:"text", readonly:"true", "data-role":"last", value: last })
        ]);

        const newInp = el("input", { type:"text", inputmode:"decimal", placeholder:"Ievadi jauno rādījumu", "data-role":"new" });
        const f3 = el("div", { class:"field" }, [
          el("label", { text:"Jaunais rādījums" }),
          newInp
        ]);

        const consInp = el("input", { type:"text", inputmode:"decimal", placeholder:"Ievadi patēriņu", "data-role":"cons" });
        const f4 = el("div", { class:"field" }, [
          el("label", { text:"Patēriņš" }),
          consInp
        ]);

        const histBtn = el("button", {
          type:"button",
          class:"histIconBtn",
          onclick: () => openHistory(addrText, cNr, meter),
          title:"Patēriņa vēsture"
        }, [
          el("img", { src:"/assets/history.png?v=2", alt:"Vēsture" })
        ]);

        
        // invite: locked meters (server can send m.locked=true)
        if (m && m.locked) {
          row.setAttribute("data-locked", "1");
          newInp.disabled = true;
          consInp.disabled = true;
          newInp.placeholder = "Jau iesniegts";
          consInp.placeholder = "Jau iesniegts";
        } else {
          row.setAttribute("data-locked", "0");
        }
const f5 = el("div", { class:"field historyCell" }, [
          el("label", { text:"." }),
          histBtn
        ]);

        newInp.addEventListener("input", () => {
          newInp.value = normalizeReadingInput(newInp.value);
          computeFromNew(row);
          refreshAll();
        });

        consInp.addEventListener("input", () => {
          consInp.value = normalizeReadingInput(consInp.value);
          computeFromCons(row);
          refreshAll();
        });

        row.append(f1, f2, f3, f4, f5);
        metersHost.appendChild(row);
      });

      block.append(head, metersHost);
      host.appendChild(block);
    });

    $("#autoSection").style.display = "block";
    setSubmitVisible(true);   /* <-- parādām tikai tagad */
  }

  async function runLookup(){
    MODE = "lookup";
    LOOKUP_ATTEMPTED = true;

    const abon = readAbonentaKods();
    const contract = readContractNr();

    if (INVITE_MODE) {
      if (LOOKUP_LOADING) return ["Notiek ielāde… uzgaidi."];
      if (!LOOKUP_FOUND) return ["Neizdevās ielādēt datus. Pamēģini atvērt linku vēlreiz."];
      if (INVITE_ALL_LOCKED) return ["Viss iesniegts šim mēnesim."];
      const built = buildInvitePayload();
      if (!built.ok) return [built.error];
      return [];
    }

    LOOKUP_FOUND = false;
    clearAuto();
    setSubmitVisible(false);

    $("#errAbonents").classList.toggle("show", !!abon && !CFG.abonRegex.test(abon));
    $("#errContract").classList.toggle("show", !!contract === false);

    if (!CFG.abonRegex.test(abon) || !contract){
      setLookupNotice("bad", "<b>Lūdzu ievadi abonenta kodu (8 cipari) un līguma numuru, tad nospied IEVADĪT.</b>");
      refreshAll();
      return;
    }

    LOOKUP_LOADING = true;
    setLookupNotice("loading", "<b>Meklēju skaitītājus…</b> Lūdzu uzgaidi.");
    refreshAll();

    try{
      const res = await fetch(`/api/lookup?subscriber=${encodeURIComponent(abon)}&contract=${encodeURIComponent(contract)}`);
      const j = await res.json().catch(()=>null);

      if (!res.ok || !j || j.ok !== true){
        setLookupNotice("bad", "<b>Neizdevās veikt meklēšanu.</b> Pamēģini vēlreiz.");
        LOOKUP_FOUND = false;
        clearAuto();
        setSubmitVisible(false);
        refreshAll();
        return;
      }

      if (j.found !== true || !Array.isArray(j.addresses) || j.addresses.length === 0){
        setLookupNotice("bad", "<b>Klients netika atrasts.</b>");
        LOOKUP_FOUND = false;
        clearAuto();
        setSubmitVisible(false);
        showModal('#notFoundModal');
        refreshAll();
        return;
      }

      setLookupNotice("good", "<b>Dati atrasti.</b> Ievadi jauno rādījumu vai patēriņu visiem skaitītājiem.");
      renderAuto(j.addresses);
      LOOKUP_FOUND = true;
      document.getElementById("autoSection").scrollIntoView({ behavior:"smooth", block:"start" });

      refreshAll();
    } catch {
      setLookupNotice("bad", "<b>Neizdevās veikt meklēšanu.</b> Pamēģini vēlreiz.");
      LOOKUP_FOUND = false;
      clearAuto();
      setSubmitVisible(false);
      refreshAll();
    } finally {
      LOOKUP_LOADING = false;
      refreshAll();
    }
  }

  // ===== Manual form =====
  async function fetchAddressSuggestions(q) {
    const res = await fetch(`/api/addresses?q=${encodeURIComponent(q)}&limit=${CFG.addrLimit}`);
    if (!res.ok) return [];
    const data = await res.json();
    const arr = data.items || [];
    return Array.isArray(arr) ? arr : [];
  }

  function buildSuggestionsBox() { return el("div", { class:"suggestions" }); }
  function showSuggestions(box, items, onPick) {
    box.innerHTML = "";
    for (const t of items) {
      const b = el("button", { type:"button", class:"sitem", text:t });
      b.addEventListener("click", () => onPick(t));
      box.appendChild(b);
    }
    box.classList.add("show");
  }
  function hideSuggestions(box) { box.classList.remove("show"); }

  function attachAddressAutocomplete(inputEl) {
    const box = buildSuggestionsBox();
    inputEl.parentElement.appendChild(box);

    let t = null;
    const update = () => {
      const q = inputEl.value.trim();
      clearTimeout(t);
      if (q.length < CFG.addrMinChars) { hideSuggestions(box); return; }

      t = setTimeout(async () => {
        const items = await fetchAddressSuggestions(q);
        if (!items.length) { hideSuggestions(box); return; }
        showSuggestions(box, items, (picked) => {
          inputEl.value = picked;
          hideSuggestions(box);
          refreshAll();
        });
      }, 180);
    };

    inputEl.addEventListener("input", () => { update(); refreshAll(); });
    inputEl.addEventListener("focus", update);
    inputEl.addEventListener("keydown", (e) => { if (e.key === "Escape") hideSuggestions(box); });

    document.addEventListener("click", (e) => {
      if (!inputEl.parentElement.contains(e.target)) hideSuggestions(box);
    });
  }

  function updateMeterDeleteButtons(addressBlock) {
    const rows = $$(".meter-row", addressBlock);
    rows.forEach((r, idx) => {
      const btn = $(".del-btn", r);
      if (!btn) return;
      btn.classList.toggle("hidden", idx < CFG.meterDeleteShownFromIndex);
    });
  }

  function createMeterRow(addressBlock) {
    const row = el("div", { class:"meter-row" });

    const nrInput = el("input", { type:"text", inputmode:"numeric", "data-role":"meterNr" });
    nrInput.addEventListener("input", () => {
      nrInput.value = nrInput.value.replace(/\D/g, "");
      refreshAll();
    });

    const valInput = el("input", { type:"text", inputmode:"decimal", "data-role":"reading" });
    valInput.addEventListener("input", () => {
      valInput.value = normalizeReadingInput(valInput.value);
      refreshAll();
    });

    const f1 = el("div", { class:"field meterNrField" }, [ el("label", {text:"Skaitītāja Nr"}), nrInput ]);
    const f2 = el("div", { class:"field readingField" }, [ el("label", {text:"Rādījums"}), valInput ]);

    const delBtn = el("button", {
      type:"button",
      class:"del-btn hidden",
      onclick: () => { row.remove(); updateMeterDeleteButtons(addressBlock); refreshAll(); }
    }, [el("span", {text:"✕"})]);

    const delCell = el("div", { class:"delCell" }, [delBtn]);
    row.append(f1, f2, delCell);
    return row;
  }

  function createAddressBlock() {
    const block = el("div", { class:"address-block" });

    const addressInput = el("input", { type:"text", "data-role":"addressText", autocomplete:"off" });
    const addressField = el("div", { class:"field" }, [ el("label", {text:"Adrese"}), addressInput ]);

    const metersHost = el("div", { class:"meters" });
    metersHost.appendChild(createMeterRow(block));

    const addMeterBtn = el("button", {
      type:"button",
      class:"btn-add-meter",
      text:"+ Pievienot skaitītāju",
      onclick: () => {
        metersHost.appendChild(createMeterRow(block));
        updateMeterDeleteButtons(block);
        refreshAll();
      }
    });

    block.append(addressField, metersHost, addMeterBtn);
    attachAddressAutocomplete(addressInput);
    updateMeterDeleteButtons(block);
    return block;
  }

  function initAddresses() {
    const host = $("#addresses");
    host.innerHTML = "";
    host.appendChild(createAddressBlock());
  }

  function buildLinesManual() {
    const lines = [];
    const blocks = $$(".address-block", $("#addresses"));
    for (const block of blocks) {
      const adrese = ($("input[data-role='addressText']", block).value || "").trim();
      const meterRows = $$(".meter-row", block);

      for (const r of meterRows) {
        const meter = ($("input[data-role='meterNr']", r).value || "").trim();
        const readingRaw = ($("input[data-role='reading']", r).value || "").trim();
        lines.push({ adrese, skaititaja_numurs: meter, radijums_raw: readingRaw });
      }
    }
    return lines;
  }

  function buildLinesLookup() {
    const rows = $$(".auto-meter-row", $("#autoAddresses"));
    const out = [];

    for (const r of rows) {
      const meter = r.getAttribute("data-meter") || "";
      const contract = r.getAttribute("data-contract") || "";

      const prev = parseReading($("input[data-role='last']", r).value);

      const newRaw = $("input[data-role='new']", r).value;
      const consRaw = $("input[data-role='cons']", r).value;

      const newNorm = normalizeReadingInput(newRaw);
      const consNorm = normalizeReadingInput(consRaw);

      const newNum = parseReading(newNorm);
      const consNum = parseReading(consNorm);

      let reading = "";

      if (newNorm && CFG.readingRegex.test(newNorm) && newNum != null) {
        reading = newNorm;
      } else if (consNorm && CFG.readingRegex.test(consNorm) && consNum != null && prev != null) {
        reading = (prev + consNum).toFixed(2);
      } else {
        reading = "";
      }

      out.push({ meter_no: meter, contract_nr: contract, reading, _newRaw: newNorm, _consRaw: consNorm, _prev: prev });
    }
    return out;
  }

  function getBlockingReasons() {
    const reasons = [];
    const abon = readAbonentaKods();
    const contract = readContractNr();

    const showAbonErr = (ABON_TOUCHED || LOOKUP_ATTEMPTED) && !!abon && !CFG.abonRegex.test(abon);
    const showContractErr = (CONTRACT_TOUCHED || LOOKUP_ATTEMPTED) && MODE === "lookup" && !contract;

    $("#errAbonents").classList.toggle("show", showAbonErr);
    $("#errContract").classList.toggle("show", showContractErr);

    if (!CFG.abonRegex.test(abon)) reasons.push("Abonenta kodam jābūt 8 cipariem.");

    if (MODE === "lookup") {
      if (!contract) reasons.push("Līguma numurs ir obligāts.");

      if (CFG.abonRegex.test(abon) && contract && !LOOKUP_ATTEMPTED) {
        reasons.push("Nospied IEVADĪT, lai ielādētu skaitītājus.");
        return reasons;
      }
      if (LOOKUP_LOADING) reasons.push("Notiek datu meklēšana… uzgaidi.");

      if (LOOKUP_ATTEMPTED && CFG.abonRegex.test(abon) && contract && !LOOKUP_FOUND) {
        reasons.push("Dati nav atrasti. Pārbaudi ievadi vai izvēlies manuālo ievadi.");
        return reasons;
      }

      if (LOOKUP_FOUND) {
        const rows = buildLinesLookup();
        if (!rows.length) reasons.push("Nav atrasts neviens skaitītājs.");

        rows.forEach((ln, idx) => {
          const newNorm = ln._newRaw || "";
          const consNorm = ln._consRaw || "";
          const prev = ln._prev;

          const hasNew = !!newNorm;
          const hasCons = !!consNorm;

          if (!hasNew && !hasCons) {
            reasons.push(`Skaitītājs ${idx+1}: ievadi jauno rādījumu vai patēriņu.`);
            return;
          }

          if (hasNew) {
            if (!CFG.readingRegex.test(newNorm)) {
              reasons.push(`Skaitītājs ${idx+1}: jaunajam rādījumam jābūt skaitlim (līdz 2 zīmēm aiz komata).`);
              return;
            }
          } else if (hasCons) {
            if (prev == null) {
              reasons.push(`Skaitītājs ${idx+1}: nevar ievadīt patēriņu, ja nav zināms pēdējais rādījums.`);
              return;
            }
            if (!CFG.readingRegex.test(consNorm)) {
              reasons.push(`Skaitītājs ${idx+1}: patēriņam jābūt skaitlim (līdz 2 zīmēm aiz komata).`);
              return;
            }
          }

          if (!ln.reading) reasons.push(`Skaitītājs ${idx+1}: ievade nav korekta.`);
        });
      }

      return reasons;
    }

    // manual
    const blocks = $$(".address-block", $("#addresses"));
    if (blocks.length < 1) reasons.push("Nav pievienota neviena adrese.");

    blocks.forEach((block, ai) => {
      const addr = ($("input[data-role='addressText']", block).value || "").trim();
      if (!addr) reasons.push(`Adrese ${ai+1}: nav ievadīta adrese.`);
    });

    const lines = buildLinesManual().filter(x => x.adrese || x.skaititaja_numurs || x.radijums_raw);
    if (!lines.length) reasons.push("Nav ievadīts neviens skaitītājs.");

    lines.forEach((ln, idx) => {
      if (!ln.adrese) return;
      if (!CFG.meterNrRegex.test(ln.skaititaja_numurs)) reasons.push(`Skaitītājs ${idx+1}: Nr jābūt tikai cipariem.`);
      const rNorm = normalizeReadingInput(ln.radijums_raw);
      if (!CFG.readingRegex.test(rNorm)) reasons.push(`Skaitītājs ${idx+1}: rādījumam jābūt skaitlim (līdz 2 zīmēm aiz komata).`);
    });

    return reasons;
  }

  function updateSubmitState() {
    const reasons = getBlockingReasons();
    const ok = reasons.length === 0;

    const btn = $("#submitBtn");
    btn.classList.toggle("disabled", !ok);
    btn.setAttribute("aria-disabled", ok ? "false" : "true");

    if (ok) {
      $("#submitInfo").classList.remove("show");
      $("#submitInfo").innerHTML = "";
    }
  }

  function showSubmitBlockedInfo() {
    const reasons = getBlockingReasons();
    const box = $("#submitInfo");
    if (!reasons.length) { box.classList.remove("show"); box.innerHTML=""; return; }

    box.innerHTML =
      "<b>Kāpēc poga IESNIEGT ir neaktīva:</b><ul style='margin:8px 0 0 18px; padding:0;'>" +
      reasons.map(r => `<li>${r}</li>`).join("") +
      "</ul>";
    box.classList.add("show");
  }

  function switchToManual(){
    MODE = "manual";
    LOOKUP_FOUND = false;
    LOOKUP_LOADING = false;
    setLookupNotice(null, "");
    clearAuto();
    $("#manualSection").style.display = "block";
    initAddresses();
    setSubmitVisible(true);   /* <-- parādām manual režīmā */
    refreshAll();
    $("#manualSection").scrollIntoView({ behavior:"smooth", block:"start" });
  }

  async function submit() {
    updateSubmitState();
    const btn = $("#submitBtn");
    if (btn.classList.contains("disabled")) { showSubmitBlockedInfo(); return; }

    btn.classList.add("disabled");
    btn.setAttribute("aria-disabled", "true");

    const KEY = "client_submission_id_current";
    let cid = sessionStorage.getItem(KEY);
    if (!cid) {
      cid = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2);
      sessionStorage.setItem(KEY, cid);
    }

    modalStateSending();

    const abon = readAbonentaKods();
    const contract = readContractNr();

    let payload = null;

    if (MODE === "lookup") {
      payload = {
        mode: "lookup",
        abonenta_numurs: abon,
        contract_nr: contract,
        lines: buildLinesLookup().map(x => ({ meter_no: x.meter_no, contract_nr: x.contract_nr, reading: x.reading })),
        website: "",
        client_submission_id: cid
      };
    } else {
      payload = {
        mode: "manual",
        abonenta_numurs: abon,
        lines: buildLinesManual().filter(x => x.adrese || x.skaititaja_numurs || x.radijums_raw).map(x => ({
          adrese: x.adrese,
          skaititaja_numurs: x.skaititaja_numurs,
          radijums: normalizeReadingInput(x.radijums_raw)
        })),
        website: "",
        client_submission_id: cid
      };
    }

    try {
      const res = await fetch("/api/submit", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const j = await res.json().catch(()=>null);

      if (!res.ok || !j || j.ok !== true) {
        modalStateError((j && j.error) ? j.error : "Neizdevās nosūtīt.");
        btn.classList.remove("disabled");
        btn.setAttribute("aria-disabled", "false");
        return;
      }

      sessionStorage.removeItem(KEY);
      modalStateSuccess();
    } catch {
      modalStateError("Savienojuma problēma. Lūdzu, mēģini vēlreiz.");
      btn.classList.remove("disabled");
      btn.setAttribute("aria-disabled", "false");
    }
  }

  function refreshAll(){ updateSubmitState(); }

  function resetFormAll(){
    $$("#abonentaCodeBoxes input").forEach(i => i.value="");
    $("#contractNr").value = "";

    MODE = "lookup";
    LOOKUP_FOUND = false;
    LOOKUP_LOADING = false;
    LOOKUP_ATTEMPTED = false;

    setLookupNotice(null, "");
    clearAuto();

    $("#manualSection").style.display = "none";
    $("#addresses").innerHTML = "";
    CONTRACT_TOUCHED = false;
    ABON_TOUCHED = false;
    $("#errAbonents").classList.remove("show");
    $("#errContract").classList.remove("show");

    setSubmitVisible(false);
    refreshAll();
  }

  // ===== INVITE helpers =====
  function detectInviteTokenFromPath(){
    const m = window.location.pathname.match(/^\/i\/([A-Za-z0-9_-]{20,})$/);
    return m ? m[1] : "";
  }

  function hideLookupUIForInvite(){
    $("#abonField").style.display = "none";
    $("#contractField").style.display = "none";
    $("#lookupRow").style.display = "none";
    $("#subscriberTitle").style.display = "none";
  }

  function lockMetersInUI(meters){
    const set = new Set((meters || []).map(x => `${x.contract_nr}|${x.meter_no}`));
    const rows = $$(".auto-meter-row", $("#autoAddresses"));
    for (const r of rows) {
      const c = r.getAttribute("data-contract") || "";
      const m = r.getAttribute("data-meter") || "";
      if (!set.has(`${c}|${m}`)) continue;

      r.setAttribute("data-locked", "1");
      const newEl = $("input[data-role='new']", r);
      const consEl = $("input[data-role='cons']", r);
      if (newEl) { newEl.disabled = true; newEl.placeholder = "Jau iesniegts"; newEl.value = ""; }
      if (consEl) { consEl.disabled = true; consEl.placeholder = "Jau iesniegts"; consEl.value = ""; }
      r.classList.remove("neg");
    }
  }

  function buildInvitePayload(){
    const rows = $$(".auto-meter-row", $("#autoAddresses"));
    const lines = [];

    function calcReadingForRow(r){
      const prev = parseReading($("input[data-role='last']", r)?.value);
      const newNorm = normalizeReadingInput($("input[data-role='new']", r)?.value || "");
      const consNorm = normalizeReadingInput($("input[data-role='cons']", r)?.value || "");

      const hasNew = !!newNorm;
      const hasCons = !!consNorm;

      if (!hasNew && !hasCons) return { hasAny:false, ok:true, reading:"" };

      if (hasNew) {
        if (!CFG.readingRegex.test(newNorm)) return { hasAny:true, ok:false, reading:"" };
        return { hasAny:true, ok:true, reading:newNorm };
      }

      if (prev == null) return { hasAny:true, ok:false, reading:"" };
      if (!CFG.readingRegex.test(consNorm)) return { hasAny:true, ok:false, reading:"" };
      const cons = parseReading(consNorm);
      if (cons == null) return { hasAny:true, ok:false, reading:"" };
      return { hasAny:true, ok:true, reading:(prev + cons).toFixed(2) };
    }

    for (const r of rows) {
      const locked = (r.getAttribute("data-locked") === "1");
      if (locked) continue;

      const contract = r.getAttribute("data-contract") || "";
      const meter = r.getAttribute("data-meter") || "";
      if (!contract || !meter) continue;

      const st = calcReadingForRow(r);
      if (!st.hasAny) continue;

      if (!st.ok || !st.reading) {
        return { ok:false, error:`Skaitītājs ${meter}: pārbaudi ievadi (formatējums) vai izdzēs ievadi.`, lines: [] };
      }

      lines.push({ meter_no: meter, contract_nr: contract, reading: st.reading });
    }

    if (!lines.length) return { ok:false, error:"Ievadi rādījumu vismaz vienam skaitītājam.", lines: [] };
    return { ok:true, lines };
  }

  async function enterInviteMode(token){
    INVITE_MODE = true;
    INVITE_TOKEN = token;

    MODE = "lookup";
    LOOKUP_ATTEMPTED = true;
    LOOKUP_LOADING = true;
    LOOKUP_FOUND = false;

    INVITE_SUBSCRIBER = "";
    INVITE_ALL_LOCKED = false;

    hideLookupUIForInvite();
    clearAuto();
    setSubmitVisible(false);

    setLookupNotice("loading", "<b>Ielādēju datus…</b> Lūdzu uzgaidi.");

    try {
      const res = await fetch(`/api/invite/resolve?token=${encodeURIComponent(token)}`);
      const j = await res.json().catch(()=>null);

      if (!res.ok || !j || j.ok !== true) {
        if (j && j.error === "WINDOW_CLOSED") {
          setLookupNotice("bad", "<b>Iesniegšana šobrīd nav pieejama.</b> Lūdzu, iesniedz rādījumus no 25.datuma līdz mēneša beigām.");
        } else {
          setLookupNotice("bad", "<b>Links nav derīgs vai termiņš beidzies.</b>");
        }
        LOOKUP_LOADING = false;
        refreshAll();
        return;
      }

      INVITE_SUBSCRIBER = j.subscriber_code || "";
      INVITE_ALL_LOCKED = !!j.all_locked;

      setLookupNotice("good", INVITE_ALL_LOCKED
        ? "<b>Viss iesniegts.</b> Šim mēnesim visi skaitītāji jau ir iesniegti."
        : "<b>Dati ielādēti.</b> Ievadi jauno rādījumu vai patēriņu."
      );

      renderAuto(j.addresses || []);
      LOOKUP_FOUND = true;

      if (INVITE_ALL_LOCKED) setSubmitVisible(false);
      else setSubmitVisible(true);

      document.getElementById("autoSection").scrollIntoView({ behavior:"smooth", block:"start" });
    } catch {
      setLookupNotice("bad", "<b>Neizdevās ielādēt datus.</b> Pamēģini vēlreiz.");
      setSubmitVisible(false);
    } finally {
      LOOKUP_LOADING = false;
      refreshAll();
    }
  }

  async function submitInvite(){
    const built = buildInvitePayload();
    if (!built.ok) {
      modalStateError(built.error);
      return;
    }

    modalStateSending();

    try {
      const res = await fetch("/api/invite/submit", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ token: INVITE_TOKEN, lines: built.lines, website: "" })
      });
      const j = await res.json().catch(()=>null);

      if (!res.ok || !j || j.ok !== true) {
        modalStateError((j && j.error) ? j.error : "Neizdevās nosūtīt.");
        return;
      }

      lockMetersInUI(j.newly_locked_meters || []);

      if (j.all_locked) {
        INVITE_ALL_LOCKED = true;
        setSubmitVisible(false);
        setLookupNotice("good", "<b>Viss iesniegts.</b> Šim mēnesim visi skaitītāji jau ir iesniegti.");
      } else {
        setLookupNotice("good", "<b>Iesniegts.</b> Vari iesniegt arī atlikušos skaitītājus.");
      }

      modalStateSuccess();
    } catch {
      modalStateError("Savienojuma problēma. Lūdzu, mēģini vēlreiz.");
    } finally {
      refreshAll();
    }
  }

  function init() {
    initCodeBoxes();
    refreshWindowNotice();
    setLookupNotice(null, "");
    setSubmitVisible(false);  /* <-- sākumā slēpts */

    $("#contractNr").addEventListener("input", () => {
      CONTRACT_TOUCHED = true;
      if (MODE === "lookup") {
        LOOKUP_FOUND = false;
        LOOKUP_ATTEMPTED = false;
        LOOKUP_LOADING = false;
        setLookupNotice(null, "");
        clearAuto();
        setSubmitVisible(false);
      }
      refreshAll();
    });

    $("#contractNr").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        $("#lookupBtn").click();
      }
    });

    $("#lookupBtn").addEventListener("click", () => runLookup());

    $("#addAddressBtn").addEventListener("click", () => {
      $("#addresses").appendChild(createAddressBlock());
      refreshAll();
    });

    $("#submitBtn").addEventListener("click", () => {
      if ($("#submitBtn").classList.contains("disabled")) showSubmitBlockedInfo();
      else { if (INVITE_MODE) submitInvite(); else submit(); }
    });


    const inviteTok = detectInviteTokenFromPath();
    if (inviteTok) {
      enterInviteMode(inviteTok);
      return;
    }
    refreshAll();
  }

  init();
</script>
</body>
</html>
