<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Åªdens skaitÄ«tÄju rÄdÄ«jumu iesniegÅ¡ana</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --border:#d8dde3;
      --muted:#6b7280;
      --blue:#1f5f86;
      --danger:#b00020;
      --radius:14px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{ box-sizing:border-box; }
    body{ background:var(--bg); margin:0; padding:24px; color:#111; }
    .wrap{ max-width:980px; margin:0 auto; }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }
    h1{ margin:0 0 14px; font-size:20px; font-weight:900; }
    .section-title{ font-size:14px; font-weight:900; margin:14px 0 8px; color:#1b1b1b; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; position:relative; }
    label{ font-size:13px; color:#222; font-weight:800; }

    input, button{ font:inherit; }
    input[type="text"]{
      border:2px solid #cfd6de;
      border-radius:var(--radius);
      padding:12px 12px;
      background:#fff;
      outline:none;
      transition:border-color .15s ease;
      width:100%;
    }
    input:focus{ border-color:var(--blue); }
    input[readonly], input:disabled{ background:#f3f5f8; color:#111; }

    .hint{ font-size:12px; color:#666; margin-top:-2px; }
    .error{ font-size:12px; color:var(--danger); display:none; }
    .error.show{ display:block; }

    .noticeBox{
      margin:0 0 12px;
      border:1px solid #f0c9cf;
      background:#fff5f7;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      color:#7a0016;
      display:none;
    }
    .noticeBox.show{ display:block; }

    .lookupBox{
      margin:0 0 12px;
      border:1px solid #cfd6de;
      background:#f7fafc;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      color:#1b1b1b;
      display:none;
    }
    .lookupBox.show{ display:block; }
    .lookupBox.loading{ opacity:.85; }
    .lookupBox.good{ border-color:#cfe8d6; background:#f3fff6; }
    .lookupBox.bad{ border-color:#f0c9cf; background:#fff5f7; color:#7a0016; }

    /* palÄ«dzÄ«bas rinda: teksts + sarkans ? */
    .helpRow{ display:flex; align-items:center; gap:10px; margin-top:6px; }
    .helpLink{
      font-size:13px; font-weight:900; color:var(--blue);
      cursor:pointer; user-select:none;
    }
    .helpLink:hover{ text-decoration:underline; }
    .helpQ{
      width:34px; height:34px; border-radius:999px;
      border:none; background:var(--danger); color:#fff;
      font-weight:1000; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
      box-shadow:0 6px 18px rgba(176,0,32,.25);
    }
    .helpQ:active{ transform:translateY(1px); }

    /* 8 ciparu lauki */
    .code-boxes{ display:flex; gap:8px; width:fit-content; max-width:100%; overflow:hidden; }
    .code-boxes input{
      width:40px;height:46px;flex:0 0 40px;
      text-align:center;font-size:18px;font-weight:900;
      border-radius:12px;border:2px solid #cfd6de;padding:0;
    }
    @media (max-width:520px){
      .code-boxes{ width:100%; display:grid; grid-template-columns:repeat(8, minmax(0,1fr)); gap:6px; }
      .code-boxes input{ width:100%; height:44px; font-size:16px; }
    }

    .btn-row{ display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
    .btn-secondary{
      border-radius:14px; border:2px solid #cfd6de; background:#fff;
      padding:12px 14px; cursor:pointer; font-weight:900;
    }
    .btn-secondary:hover{ background:#eef3f8; }

    .btn-primary{
      border-radius:14px; border:none; background:var(--blue); color:#fff;
      padding:14px 18px; cursor:pointer; font-weight:1000; width:100%; margin-top:14px;
    }
    .btn-primary.disabled{ opacity:.55; cursor:not-allowed; }

    .address-block{
      border:2px solid #e3e7ec;
      border-radius:18px;
      padding:14px;
      margin-top:12px;
      background:#fff;
      position:relative;
    }
    .address-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin-bottom:8px; }
    .auto-address-title{ font-size:13px; font-weight:1000; color:#111; padding-top:2px; }

    .addrActions{ display:flex; align-items:center; gap:10px; }
    .histBtn{
      border-radius:12px; border:2px solid #cfd6de; background:#fff;
      padding:8px 10px; cursor:pointer; font-weight:1000; color:#111;
      display:inline-flex; align-items:center; gap:8px;
    }
    .histBtn:hover{ background:#eef3f8; }
    .histBtn span{ font-size:16px; }

    .meters{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }

    /* manual meter row */
    .meter-row{
      display:grid;
      grid-template-columns: 1fr 1fr 56px;
      gap:10px;
      align-items:end;
    }
    .meterNrField{ grid-column:1; }
    .readingField{ grid-column:2; }
    .delCell{ grid-column:3; display:flex; justify-content:flex-end; align-items:flex-end; }
    .del-btn{
      width:42px;height:42px;border-radius:12px;border:2px solid #f0c9cf;
      background:#fff;color:var(--danger);cursor:pointer;font-weight:1000;
    }
    .del-btn.hidden{ display:none; }

    .btn-add-meter{
      border-radius:12px;border:2px dashed #cfd6de;background:#f9fbfd;
      padding:10px 14px;font-weight:900;color:#1976d2;cursor:pointer;width:fit-content;margin-top:8px;
    }
    .btn-add-meter:hover{ background:#eef3f8; }

    @media (max-width:640px){
      .meter-row{ grid-template-columns: 1fr; grid-template-rows:auto auto auto; }
      .delCell{ justify-content:stretch; }
      .del-btn{ width:100%; height:auto; padding:12px 14px; border-radius:14px; }
      .del-btn span{ display:none; }
      .del-btn::before{ content:"DzÄ“st skaitÄ«tÄju"; }
      .address-head{ flex-direction:column; align-items:stretch; gap:8px; }
      .addrActions{ justify-content:flex-end; }
      .histBtn{ width:100%; justify-content:center; }
    }

    /* autocomplete */
    .suggestions{
      position:absolute; top:100%; left:0; right:0;
      background:#fff; border:1px solid var(--border); border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.12);
      overflow:hidden; z-index:50; margin-top:6px;
      display:none; max-height:320px; overflow-y:auto;
    }
    .suggestions.show{ display:block; }
    .sitem{
      width:100%; text-align:left; padding:10px 12px; background:#fff; border:none;
      cursor:pointer; font-size:13px; line-height:1.25;
    }
    .sitem:hover{ background:#eef3f8; }

    .infoBox{
      margin-top:10px;border:1px solid #f0c9cf;background:#fff5f7;border-radius:14px;
      padding:10px 12px;font-size:13px;color:#7a0016;display:none;
    }
    .infoBox.show{ display:block; }

    /* AUTO */
    #autoSection{ display:none; margin-top:10px; }
    .auto-meter-row{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 140px;
      gap:10px;
      align-items:end;
      margin-top:10px;
    }
    .auto-meter-row.neg input[data-role="cons"]{ color:var(--danger); font-weight:1000; }
    @media (max-width:640px){ .auto-meter-row{ grid-template-columns: 1fr; } }

    /* submit modal */
    #submitModal, #notFoundModal, #helpModal, #historyModal { position: fixed; inset: 0; z-index: 9999; display:none; }
    .modalBackdrop { position: absolute; inset: 0; background: rgba(0,0,0,.35); }
    .modalCard{
      position:absolute; left:50%; top:50%; transform: translate(-50%,-50%);
      width:min(560px, calc(100vw - 32px));
      background:#fff; border:1px solid #e5e7eb; border-radius:16px;
      padding:16px; box-shadow: 0 18px 50px rgba(0,0,0,.18);
    }
    .modalTitle{ font-weight:900; font-size:16px; margin:0 0 8px; }
    .modalText{ font-size:14px; color:#333; margin:0 0 12px; }
    .modalActions{ display:flex; gap:10px; justify-content:flex-end; }
    .btn-outline{
      border-radius:12px; padding:10px 12px; font-weight:900; cursor:pointer;
      border:2px solid #cfd6de; background:#fff;
    }
    .btn-outline.primary{ border-color: var(--blue); color: var(--blue); }
    .btn-outline.danger{ border-color: var(--danger); color: var(--danger); }

    #helpImg{ width:100%; height:auto; border-radius:12px; border:1px solid #e5e7eb; display:block; }

    /* history */
    #histCanvas{ width:100%; height:240px; border:1px solid #eee; border-radius:14px; }
    #histMeta{ font-size:12px; color:#666; margin-top:8px; }
    #histLoading{ font-size:13px; color:#333; margin-bottom:10px; }

    #manualSection{ display:none; }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Åªdens skaitÄ«tÄju rÄdÄ«jumu iesniegÅ¡ana</h1>

    <div id="windowNotice" class="noticeBox"></div>
    <div id="lookupNotice" class="lookupBox"></div>

    <div class="section-title">Abonenta informÄcija</div>

    <div class="field">
      <label>Abonenta numurs (8 cipari)</label>
      <div class="code-boxes" id="abonentaCodeBoxes"></div>
      <div class="helpRow">
        <div class="helpLink" id="helpLink1">Kur to atrast rÄ“Ä·inÄ?</div>
        <button type="button" class="helpQ" id="helpBtn1" aria-label="PalÄ«dzÄ«ba">?</button>
      </div>
      <div class="error" id="errAbonents">Abonenta numuram jÄbÅ«t 8 cipariem.</div>
    </div>

    <div class="field">
      <label>LÄ«guma numurs</label>
      <input id="contractNr" type="text" autocomplete="off" placeholder="Ievadi lÄ«guma numuru" />
      <div class="helpRow">
        <div class="helpLink" id="helpLink2">Kur to atrast rÄ“Ä·inÄ?</div>
        <button type="button" class="helpQ" id="helpBtn2" aria-label="PalÄ«dzÄ«ba">?</button>
      </div>
      <div class="error" id="errContract">LÅ«dzu ievadi lÄ«guma numuru.</div>
    </div>

    <div class="btn-row">
      <button class="btn-secondary" id="lookupBtn" type="button">IEVADÄªT</button>
    </div>

    <div id="autoSection">
      <div class="section-title">SkaitÄ«tÄji</div>
      <div id="autoAddresses"></div>
    </div>

    <div id="manualSection">
      <div class="section-title">Adreses un skaitÄ«tÄji</div>
      <div id="addresses"></div>
      <div class="btn-row">
        <button class="btn-secondary" id="addAddressBtn" type="button">+ Pievienot adresi</button>
      </div>
    </div>

    <button class="btn-primary disabled" id="submitBtn" type="button" aria-disabled="true">IESNIEGT</button>
    <div id="submitInfo" class="infoBox"></div>
  </div>
</div>

<!-- Submit popup -->
<div id="submitModal">
  <div class="modalBackdrop" id="submitBackdrop"></div>
  <div class="modalCard" id="submitCard" role="dialog" aria-modal="true">
    <div class="modalTitle" id="submitTitle">SÅªTUâ€¦</div>
    <div class="modalText" id="submitText">LÅ«dzu uzgaidi, notiek rÄdÄ«jumu nosÅ«tÄ«Å¡ana.</div>
    <div class="modalActions">
      <button type="button" class="btn-outline primary" id="submitCloseBtn" style="display:none;">AIZVÄ’RT</button>
      <button type="button" class="btn-outline danger" id="submitRetryBtn" style="display:none;">MÄ’Ä¢INÄ€T VÄ’LREIZ</button>
    </div>
  </div>
</div>

<!-- Lookup not found modal -->
<div id="notFoundModal">
  <div class="modalBackdrop" id="notFoundBackdrop"></div>
  <div class="modalCard" id="notFoundCard" role="dialog" aria-modal="true">
    <div class="modalTitle">Klients netika atrasts</div>
    <div class="modalText">
      PÄrbaudiet abonenta kodu un lÄ«guma numuru. Ja nevarat atrast datus rÄ“Ä·inÄ, ievadiet rÄdÄ«jumus manuÄli.
    </div>
    <div class="modalActions">
      <button type="button" class="btn-outline primary" id="notFoundEditBtn">Labot</button>
      <button type="button" class="btn-outline danger" id="notFoundManualBtn">IevadÄ«t manuÄli</button>
    </div>
  </div>
</div>

<!-- Help modal -->
<div id="helpModal">
  <div class="modalBackdrop" id="helpBackdrop"></div>
  <div class="modalCard" id="helpCard" role="dialog" aria-modal="true">
    <div class="modalTitle">Kur atrast abonenta kodu un lÄ«guma numuru?</div>
    <div class="modalText">Abonenta kods un lÄ«guma numurs ir norÄdÄ«ts rÄ“Ä·ina augÅ¡Ä“jÄ labajÄ stÅ«rÄ«.</div>
    <img id="helpImg" src="/assets/rekins-paraugs.png" alt="RÄ“Ä·ina fragments" />
    <div class="modalActions" style="margin-top:12px;">
      <button type="button" class="btn-outline primary" id="helpCloseBtn">AIZVÄ’RT</button>
    </div>
  </div>
</div>

<!-- History modal -->
<div id="historyModal">
  <div class="modalBackdrop" id="histBackdrop"></div>
  <div class="modalCard" id="histCard" role="dialog" aria-modal="true">
    <div class="modalTitle" id="histTitle">PatÄ“riÅ†Å¡ pa mÄ“neÅ¡iem (mÂ³)</div>
    <div id="histLoading">IelÄdÄ“juâ€¦</div>
    <canvas id="histCanvas" width="900" height="280"></canvas>
    <div id="histMeta"></div>
    <div class="modalActions" style="margin-top:12px;">
      <button type="button" class="btn-outline primary" id="histCloseBtn">AIZVÄ’RT</button>
    </div>
  </div>
</div>

<script>
  const CFG = {
    abonRegex: /^\d{8}$/,
    meterNrRegex: /^\d+$/,
    readingRegex: /^\d+([.]\d{1,2})?$/,
    addrMinChars: 1,
    addrLimit: 12,
    meterDeleteShownFromIndex: 1
  };

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function el(tag, attrs={}, children=[]) {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs)) {
      if (k === "class") n.className = v;
      else if (k === "text") n.textContent = v;
      else if (k === "value") n.value = v;
      else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, v);
    }
    children.forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
    return n;
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function setLookupNotice(type, html){
    const box = $("#lookupNotice");
    box.classList.remove("show","loading","good","bad");
    if (!html) { box.innerHTML=""; return; }
    box.innerHTML = html;
    box.classList.add("show");
    if (type) box.classList.add(type);
  }

  function normalizeReadingInput(raw) {
    let s = String(raw || '').trim().replace(',', '.');
    s = s.replace(/[^\d.]/g, '');
    const firstDot = s.indexOf('.');
    if (firstDot !== -1) {
      s = s.slice(0, firstDot + 1) + s.slice(firstDot + 1).replace(/\./g, '');
      const parts = s.split('.');
      s = parts[0] + '.' + (parts[1] || '').slice(0, 2);
    }
    return s;
  }

  function parseReading(v){
    const s = String(v || '').trim().replace(',', '.');
    if (!s) return null;
    const n = Number(s);
    return Number.isFinite(n) ? n : null;
  }

  // ===== State =====
  let MODE = "lookup";
  let LOOKUP_LOADING = false;
  let LOOKUP_FOUND = false;
  let LOOKUP_ATTEMPTED = false;

  // ===== modal helpers =====
  function showModal(id){ $(id).style.display='block'; }
  function hideModal(id){ $(id).style.display='none'; }

  // submit modal
  let MODAL_LAST_STATE = "idle";
  function modalStateSending() {
    MODAL_LAST_STATE="sending";
    showModal('#submitModal');
    $('#submitTitle').textContent='SÅªTUâ€¦';
    $('#submitText').textContent='LÅ«dzu uzgaidi, notiek rÄdÄ«jumu nosÅ«tÄ«Å¡ana.';
    $('#submitCloseBtn').style.display='none';
    $('#submitRetryBtn').style.display='none';
  }
  function modalStateSuccess() {
    MODAL_LAST_STATE="success";
    showModal('#submitModal');
    $('#submitTitle').textContent='RÄ€DÄªJUMS IESNIEGTS';
    $('#submitText').textContent='Paldies! JÅ«su rÄdÄ«jumi ir saÅ†emti.';
    $('#submitCloseBtn').style.display='inline-block';
    $('#submitRetryBtn').style.display='none';
  }
  function modalStateError(errText) {
    MODAL_LAST_STATE="error";
    showModal('#submitModal');
    $('#submitTitle').textContent='KÄ»ÅªDA';
    $('#submitText').textContent=errText || 'NeizdevÄs nosÅ«tÄ«t.';
    $('#submitCloseBtn').style.display='inline-block';
    $('#submitRetryBtn').style.display='inline-block';
  }
  $('#submitBackdrop').addEventListener('click', () => { hideModal('#submitModal'); if (MODAL_LAST_STATE==="success") resetFormAll(); });
  $('#submitCloseBtn').addEventListener('click', () => { hideModal('#submitModal'); if (MODAL_LAST_STATE==="success") resetFormAll(); });
  $('#submitRetryBtn').addEventListener('click', () => { hideModal('#submitModal'); refreshAll(); });

  // not found modal
  $('#notFoundBackdrop').addEventListener('click', () => hideModal('#notFoundModal'));
  $('#notFoundEditBtn').addEventListener('click', () => { hideModal('#notFoundModal'); $('#contractNr').focus(); });
  $('#notFoundManualBtn').addEventListener('click', () => { hideModal('#notFoundModal'); switchToManual(); });

  // help modal
  function openHelp(){ showModal('#helpModal'); }
  $('#helpBackdrop').addEventListener('click', () => hideModal('#helpModal'));
  $('#helpCloseBtn').addEventListener('click', () => hideModal('#helpModal'));
  $('#helpBtn1').addEventListener('click', openHelp);
  $('#helpBtn2').addEventListener('click', openHelp);
  $('#helpLink1').addEventListener('click', openHelp);
  $('#helpLink2').addEventListener('click', openHelp);

  // history modal (click anywhere outside card closes)
  $('#histBackdrop').addEventListener('click', () => hideModal('#historyModal'));
  $('#histCloseBtn').addEventListener('click', () => hideModal('#historyModal'));
  $('#histCard').addEventListener('click', (e) => e.stopPropagation());

  async function refreshWindowNotice() {
    const box = $("#windowNotice");
    try {
      const res = await fetch("/api/window");
      const w = await res.json();
      if (!w.is_open && w.enforce) {
        box.innerHTML = "<b>RÄdÄ«jumu iesniegÅ¡ana no 25.datuma lÄ«dz mÄ“neÅ¡a beigÄm.</b>";
        box.classList.add("show");
      } else if (!w.enforce) {
        box.innerHTML = "<b>TESTA vide:</b> iesniegÅ¡ana nav ierobeÅ¾ota pÄ“c datuma.";
        box.classList.add("show");
      } else {
        box.classList.remove("show");
        box.innerHTML = "";
      }
    } catch {
      box.classList.remove("show");
      box.innerHTML = "";
    }
  }

  function initCodeBoxes() {
    const host = $("#abonentaCodeBoxes");
    host.innerHTML = "";
    for (let i=0; i<8; i++) {
      const inp = el("input", { type:"text", inputmode:"numeric", maxlength:"1", "aria-label":`Cipars ${i+1}` });

      inp.addEventListener("input", () => {
        inp.value = inp.value.replace(/\D/g, "").slice(0,1);
        if (inp.value && i < 7) host.children[i+1].focus();

        if (MODE === "lookup") {
          LOOKUP_FOUND = false; LOOKUP_ATTEMPTED = false; LOOKUP_LOADING = false;
          setLookupNotice(null, ""); clearAuto();
        }
        refreshAll();
      });

      inp.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !inp.value && i > 0) host.children[i-1].focus();
      });

      inp.addEventListener("paste", (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData("text");
        const digits = (text || "").replace(/\D/g, "").slice(0,8);
        for (let j=0; j<8; j++) host.children[j].value = digits[j] || "";
        (host.children[Math.min(digits.length,7)] || host.children[7]).focus();

        if (MODE === "lookup") {
          LOOKUP_FOUND = false; LOOKUP_ATTEMPTED = false; LOOKUP_LOADING = false;
          setLookupNotice(null, ""); clearAuto();
        }
        refreshAll();
      });

      host.appendChild(inp);
    }
  }

  function readAbonentaKods() { return $$("#abonentaCodeBoxes input").map(i => i.value.trim()).join(""); }
  function readContractNr() { return String($("#contractNr").value || "").trim(); }

  // ===== AUTO rendering =====
  function clearAuto(){
    $("#autoAddresses").innerHTML = "";
    $("#autoSection").style.display = "none";
  }

  function drawHistoryChart(canvas, items) {
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    ctx.clearRect(0,0,w,h);

    const padL=48, padR=12, padT=16, padB=36;
    const iw = w - padL - padR;
    const ih = h - padT - padB;

    const values = items.map(x => Number(x.m3) || 0);
    const labels = items.map(x => String(x.month || '').slice(5,7)); // MM
    const maxV = Math.max(1, ...values);

    // axis
    ctx.strokeStyle = '#ddd';
    ctx.beginPath();
    ctx.moveTo(padL, padT);
    ctx.lineTo(padL, padT+ih);
    ctx.lineTo(padL+iw, padT+ih);
    ctx.stroke();

    const n = values.length || 1;
    const bw = iw / n;

    // bars
    ctx.fillStyle = '#1f5f86';
    for (let i=0;i<n;i++){
      const v = values[i];
      const bh = (v/maxV)*ih;
      const x = padL + i*bw + 3;
      const y = padT + ih - bh;
      ctx.fillRect(x, y, Math.max(2, bw-6), bh);

      // value label
      ctx.fillStyle = '#111';
      ctx.font = '12px system-ui';
      const t = (Math.round(v*100)/100).toFixed(2).replace(/\.00$/,'');
      ctx.fillText(t, x, Math.max(padT+12, y-4));
      ctx.fillStyle = '#1f5f86';
    }

    // Y labels
    ctx.fillStyle = '#555';
    ctx.font = '12px system-ui';
    ctx.fillText('0', 12, padT+ih);
    ctx.fillText(String(maxV), 12, padT+12);

    // X labels (months)
    ctx.fillStyle = '#555';
    ctx.font = '12px system-ui';
    for (let i=0;i<n;i++){
      const x = padL + i*bw + 6;
      ctx.fillText(labels[i], x, padT+ih+20);
    }
  }

  async function openHistory(address, contract) {
    const subscriber = readAbonentaKods();
    if (!CFG.abonRegex.test(subscriber) || !contract || !address) return;

    $('#histTitle').textContent = `PatÄ“riÅ†Å¡ pa mÄ“neÅ¡iem (mÂ³) â€” ${address}`;
    $('#histLoading').textContent = 'IelÄdÄ“juâ€¦';
    $('#histMeta').textContent = '';
    showModal('#historyModal');

    try {
      const res = await fetch(`/api/history?subscriber=${encodeURIComponent(subscriber)}&contract=${encodeURIComponent(contract)}&address=${encodeURIComponent(address)}`);
      const j = await res.json().catch(()=>null);
      if (!res.ok || !j || j.ok !== true) {
        $('#histLoading').textContent = 'NeizdevÄs ielÄdÄ“t vÄ“sturi.';
        return;
      }

      const items = Array.isArray(j.items) ? j.items : [];
      // noteikums: trÅ«kst/negatÄ«vs => 0
      const fixed = items.map(x => ({
        month: x.month,
        m3: (Number(x.m3) > 0 && Number.isFinite(Number(x.m3))) ? Number(x.m3) : 0
      }));

      if (!fixed.length) {
        $('#histLoading').textContent = 'VÄ“sturiskie dati nav atrasti.';
        drawHistoryChart($('#histCanvas'), Array.from({length:12}, (_,i)=>({month:'', m3:0})));
        return;
      }

      $('#histLoading').textContent = '';
      drawHistoryChart($('#histCanvas'), fixed);

      const total = fixed.reduce((a,b)=>a+(Number(b.m3)||0),0);
      $('#histMeta').textContent = `PÄ“dÄ“jie 12 mÄ“neÅ¡i â€¢ KopÄ: ${total.toFixed(2).replace(/\.00$/,'')} mÂ³`;
    } catch {
      $('#histLoading').textContent = 'NeizdevÄs ielÄdÄ“t vÄ“sturi.';
    }
  }

  function renderAuto(addresses){
    const host = $("#autoAddresses");
    host.innerHTML = "";

    function computeFromNew(row) {
      const lastEl = $("input[data-role='last']", row);
      const newEl = $("input[data-role='new']", row);
      const consEl = $("input[data-role='cons']", row);

      const prev = parseReading(lastEl.value);
      const cur = parseReading(newEl.value);

      if (prev == null || cur == null) {
        if (!String(newEl.value || '').trim()) consEl.value = "";
        row.classList.remove("neg");
        return;
      }

      const diff = cur - prev;
      consEl.value = diff.toFixed(2);
      row.classList.toggle("neg", diff < 0);
    }

    function computeFromCons(row) {
      const lastEl = $("input[data-role='last']", row);
      const newEl = $("input[data-role='new']", row);
      const consEl = $("input[data-role='cons']", row);

      const prev = parseReading(lastEl.value);
      const cons = parseReading(consEl.value);

      if (prev == null || cons == null) return;

      const cur = prev + cons;
      newEl.value = cur.toFixed(2);
      row.classList.toggle("neg", (cur - prev) < 0);
    }

    addresses.forEach((a) => {
      const addrText = String(a.address || "").trim();
      const meters = Array.isArray(a.meters) ? a.meters : [];
      const contractForAddress = (meters[0] && meters[0].contract_nr) ? String(meters[0].contract_nr) : "";

      const block = el("div", { class:"address-block" });

      const head = el("div", { class:"address-head" }, [
        el("div", { class:"auto-address-title", text: addrText }),
        el("div", { class:"addrActions" }, [
          el("button", {
            type:"button",
            class:"histBtn",
            onclick: () => openHistory(addrText, contractForAddress),
            title:"ApskatÄ«t patÄ“riÅ†u pa mÄ“neÅ¡iem"
          }, [el("span",{text:"ğŸ“Š"}), el("div",{text:"VÄ“sture"})])
        ])
      ]);

      const metersHost = el("div", { class:"meters" });

      meters.forEach((m) => {
        const meter = String(m.meter_serial || "").trim();
        const last = (m.last_reading == null) ? "" : String(m.last_reading);
        const cNr = String(m.contract_nr || "").trim();

        const row = el("div", { class:"auto-meter-row", "data-meter": meter, "data-contract": cNr });

        const f1 = el("div", { class:"field" }, [
          el("label", { text:"SkaitÄ«tÄja Nr" }),
          el("input", { type:"text", readonly:"true", value: meter }),
          cNr ? el("div", { class:"hint", text:`LÄ«gums: ${cNr}` }) : el("div", { class:"hint", text:"" })
        ]);

        const f2 = el("div", { class:"field" }, [
          el("label", { text:"PÄ“dÄ“jais rÄdÄ«jums" }),
          el("input", { type:"text", readonly:"true", "data-role":"last", value: last })
        ]);

        const newInp = el("input", { type:"text", inputmode:"decimal", placeholder:"Ievadi jauno rÄdÄ«jumu", "data-role":"new" });
        const f3 = el("div", { class:"field" }, [
          el("label", { text:"Jaunais rÄdÄ«jums" }),
          newInp
        ]);

        const consInp = el("input", { type:"text", inputmode:"decimal", placeholder:"Ievadi patÄ“riÅ†u", "data-role":"cons" });
        const f4 = el("div", { class:"field" }, [
          el("label", { text:"PatÄ“riÅ†Å¡" }),
          consInp
        ]);

        newInp.addEventListener("input", () => {
          newInp.value = normalizeReadingInput(newInp.value);
          computeFromNew(row);
          refreshAll();
        });

        consInp.addEventListener("input", () => {
          consInp.value = normalizeReadingInput(consInp.value);
          computeFromCons(row);
          refreshAll();
        });

        row.append(f1, f2, f3, f4);
        metersHost.appendChild(row);
      });

      block.append(head, metersHost);
      host.appendChild(block);
    });

    $("#autoSection").style.display = "block";
  }

  async function runLookup(){
    MODE = "lookup";
    LOOKUP_ATTEMPTED = true;

    const abon = readAbonentaKods();
    const contract = readContractNr();

    LOOKUP_FOUND = false;
    clearAuto();

    $("#errAbonents").classList.toggle("show", !!abon && !CFG.abonRegex.test(abon));
    $("#errContract").classList.toggle("show", !!contract === false);

    if (!CFG.abonRegex.test(abon) || !contract){
      setLookupNotice("bad", "<b>LÅ«dzu ievadi abonenta kodu (8 cipari) un lÄ«guma numuru, tad nospied IEVADÄªT.</b>");
      refreshAll();
      return;
    }

    LOOKUP_LOADING = true;
    setLookupNotice("loading", "<b>MeklÄ“ju skaitÄ«tÄjusâ€¦</b> LÅ«dzu uzgaidi.");
    refreshAll();

    try{
      const res = await fetch(`/api/lookup?subscriber=${encodeURIComponent(abon)}&contract=${encodeURIComponent(contract)}`);
      const j = await res.json().catch(()=>null);

      if (!res.ok || !j || j.ok !== true){
        setLookupNotice("bad", "<b>NeizdevÄs veikt meklÄ“Å¡anu.</b> PamÄ“Ä£ini vÄ“lreiz.");
        LOOKUP_FOUND = false;
        clearAuto();
        refreshAll();
        return;
      }

      if (j.found !== true || !Array.isArray(j.addresses) || j.addresses.length === 0){
        setLookupNotice("bad", "<b>Klients netika atrasts.</b>");
        LOOKUP_FOUND = false;
        clearAuto();
        showModal('#notFoundModal');
        refreshAll();
        return;
      }

      setLookupNotice("good", "<b>Dati atrasti.</b> Ievadi jauno rÄdÄ«jumu vai patÄ“riÅ†u visiem skaitÄ«tÄjiem.");
      renderAuto(j.addresses);
      LOOKUP_FOUND = true;
      document.getElementById("autoSection").scrollIntoView({ behavior:"smooth", block:"start" });

      refreshAll();
    } catch {
      setLookupNotice("bad", "<b>NeizdevÄs veikt meklÄ“Å¡anu.</b> PamÄ“Ä£ini vÄ“lreiz.");
      LOOKUP_FOUND = false;
      clearAuto();
      refreshAll();
    } finally {
      LOOKUP_LOADING = false;
      refreshAll();
    }
  }

  // ===== Manual form =====
  async function fetchAddressSuggestions(q) {
    const res = await fetch(`/api/addresses?q=${encodeURIComponent(q)}&limit=${CFG.addrLimit}`);
    if (!res.ok) return [];
    const data = await res.json();
    const arr = data.items || [];
    return Array.isArray(arr) ? arr : [];
  }

  function buildSuggestionsBox() { return el("div", { class:"suggestions" }); }
  function showSuggestions(box, items, onPick) {
    box.innerHTML = "";
    for (const t of items) {
      const b = el("button", { type:"button", class:"sitem", text:t });
      b.addEventListener("click", () => onPick(t));
      box.appendChild(b);
    }
    box.classList.add("show");
  }
  function hideSuggestions(box) { box.classList.remove("show"); }

  function attachAddressAutocomplete(inputEl) {
    const box = buildSuggestionsBox();
    inputEl.parentElement.appendChild(box);

    let t = null;
    const update = () => {
      const q = inputEl.value.trim();
      clearTimeout(t);
      if (q.length < CFG.addrMinChars) { hideSuggestions(box); return; }

      t = setTimeout(async () => {
        const items = await fetchAddressSuggestions(q);
        if (!items.length) { hideSuggestions(box); return; }
        showSuggestions(box, items, (picked) => {
          inputEl.value = picked;
          hideSuggestions(box);
          refreshAll();
        });
      }, 180);
    };

    inputEl.addEventListener("input", () => { update(); refreshAll(); });
    inputEl.addEventListener("focus", update);
    inputEl.addEventListener("keydown", (e) => { if (e.key === "Escape") hideSuggestions(box); });

    document.addEventListener("click", (e) => {
      if (!inputEl.parentElement.contains(e.target)) hideSuggestions(box);
    });
  }

  function renumberAddresses() {
    const blocks = $$(".address-block", $("#addresses"));
    blocks.forEach((block, i) => {
      const badge = $(".badge", block);
      if (!badge) return;
      badge.textContent = `Adrese ${i+1}`;
      badge.style.display = i===0 ? "none" : "inline-flex";
    });
  }

  function updateMeterDeleteButtons(addressBlock) {
    const rows = $$(".meter-row", addressBlock);
    rows.forEach((r, idx) => {
      const btn = $(".del-btn", r);
      if (!btn) return;
      btn.classList.toggle("hidden", idx < CFG.meterDeleteShownFromIndex);
    });
  }

  function createMeterRow(addressBlock) {
    const row = el("div", { class:"meter-row" });

    const nrInput = el("input", { type:"text", inputmode:"numeric", "data-role":"meterNr" });
    nrInput.addEventListener("input", () => {
      nrInput.value = nrInput.value.replace(/\D/g, "");
      refreshAll();
    });

    const valInput = el("input", { type:"text", inputmode:"decimal", "data-role":"reading" });
    valInput.addEventListener("input", () => {
      valInput.value = normalizeReadingInput(valInput.value);
      refreshAll();
    });

    const f1 = el("div", { class:"field meterNrField" }, [ el("label", {text:"SkaitÄ«tÄja Nr"}), nrInput ]);
    const f2 = el("div", { class:"field readingField" }, [ el("label", {text:"RÄdÄ«jums"}), valInput ]);

    const delBtn = el("button", {
      type:"button",
      class:"del-btn hidden",
      onclick: () => { row.remove(); updateMeterDeleteButtons(addressBlock); refreshAll(); }
    }, [el("span", {text:"âœ•"})]);

    const delCell = el("div", { class:"delCell" }, [delBtn]);
    row.append(f1, f2, delCell);
    return row;
  }

  function createAddressBlock() {
    const block = el("div", { class:"address-block" });

    const badge = el("div", { class:"badge", text:"Adrese 1" });
    badge.style.display = "none";

    const removeAddressBtn = el("button", {
      type:"button",
      class:"btn-secondary",
      text:"DzÄ“st adresi",
      onclick: () => {
        const all = $$(".address-block", $("#addresses"));
        if (all.length <= 1) return;
        block.remove();
        renumberAddresses();
        refreshAll();
      }
    });

    const head = el("div", { class:"address-head" }, [badge, removeAddressBtn]);

    const addressInput = el("input", { type:"text", "data-role":"addressText", autocomplete:"off" });
    const addressField = el("div", { class:"field" }, [ el("label", {text:"Adrese"}), addressInput ]);

    const metersHost = el("div", { class:"meters" });
    metersHost.appendChild(createMeterRow(block));

    const addMeterBtn = el("button", {
      type:"button",
      class:"btn-add-meter",
      text:"+ Pievienot skaitÄ«tÄju",
      onclick: () => {
        metersHost.appendChild(createMeterRow(block));
        updateMeterDeleteButtons(block);
        refreshAll();
      }
    });

    block.append(head, addressField, metersHost, addMeterBtn);
    attachAddressAutocomplete(addressInput);
    updateMeterDeleteButtons(block);
    return block;
  }

  function initAddresses() {
    const host = $("#addresses");
    host.innerHTML = "";
    host.appendChild(createAddressBlock());
    renumberAddresses();
  }

  function buildLinesManual() {
    const lines = [];
    const blocks = $$(".address-block", $("#addresses"));
    for (const block of blocks) {
      const adrese = ($("input[data-role='addressText']", block).value || "").trim();
      const meterRows = $$(".meter-row", block);

      for (const r of meterRows) {
        const meter = ($("input[data-role='meterNr']", r).value || "").trim();
        const readingRaw = ($("input[data-role='reading']", r).value || "").trim();
        lines.push({ adrese, skaititaja_numurs: meter, radijums_raw: readingRaw });
      }
    }
    return lines;
  }

  function buildLinesLookup() {
    const rows = $$(".auto-meter-row", $("#autoAddresses"));
    const out = [];

    for (const r of rows) {
      const meter = r.getAttribute("data-meter") || "";
      const contract = r.getAttribute("data-contract") || "";

      const prev = parseReading($("input[data-role='last']", r).value);

      const newRaw = $("input[data-role='new']", r).value;
      const consRaw = $("input[data-role='cons']", r).value;

      const newNorm = normalizeReadingInput(newRaw);
      const consNorm = normalizeReadingInput(consRaw);

      const newNum = parseReading(newNorm);
      const consNum = parseReading(consNorm);

      let reading = "";

      if (newNorm && CFG.readingRegex.test(newNorm) && newNum != null) {
        reading = newNorm;
      } else if (consNorm && CFG.readingRegex.test(consNorm) && consNum != null && prev != null) {
        reading = (prev + consNum).toFixed(2);
      } else {
        reading = "";
      }

      out.push({ meter_no: meter, contract_nr: contract, reading, _newRaw: newNorm, _consRaw: consNorm, _prev: prev });
    }
    return out;
  }

  function getBlockingReasons() {
    const reasons = [];
    const abon = readAbonentaKods();
    const contract = readContractNr();

    $("#errAbonents").classList.toggle("show", !!abon && !CFG.abonRegex.test(abon));
    $("#errContract").classList.toggle("show", MODE === "lookup" && !!contract === false);

    if (!CFG.abonRegex.test(abon)) reasons.push("Abonenta numuram jÄbÅ«t 8 cipariem.");

    if (MODE === "lookup") {
      if (!contract) reasons.push("LÄ«guma numurs ir obligÄts.");

      if (CFG.abonRegex.test(abon) && contract && !LOOKUP_ATTEMPTED) {
        reasons.push("Nospied IEVADÄªT, lai ielÄdÄ“tu skaitÄ«tÄjus.");
        return reasons;
      }
      if (LOOKUP_LOADING) reasons.push("Notiek datu meklÄ“Å¡anaâ€¦ uzgaidi.");

      if (LOOKUP_ATTEMPTED && CFG.abonRegex.test(abon) && contract && !LOOKUP_FOUND) {
        reasons.push("Dati nav atrasti. PÄrbaudi ievadi vai izvÄ“lies manuÄlo ievadi.");
        return reasons;
      }

      if (LOOKUP_FOUND) {
        const rows = buildLinesLookup();
        if (!rows.length) reasons.push("Nav atrasts neviens skaitÄ«tÄjs.");

        rows.forEach((ln, idx) => {
          const newNorm = ln._newRaw || "";
          const consNorm = ln._consRaw || "";
          const prev = ln._prev;

          const hasNew = !!newNorm;
          const hasCons = !!consNorm;

          if (!hasNew && !hasCons) {
            reasons.push(`SkaitÄ«tÄjs ${idx+1}: ievadi jauno rÄdÄ«jumu vai patÄ“riÅ†u.`);
            return;
          }

          if (hasNew) {
            if (!CFG.readingRegex.test(newNorm)) {
              reasons.push(`SkaitÄ«tÄjs ${idx+1}: jaunajam rÄdÄ«jumam jÄbÅ«t skaitlim (lÄ«dz 2 zÄ«mÄ“m aiz komata).`);
              return;
            }
          } else if (hasCons) {
            if (prev == null) {
              reasons.push(`SkaitÄ«tÄjs ${idx+1}: nevar ievadÄ«t patÄ“riÅ†u, ja nav zinÄms pÄ“dÄ“jais rÄdÄ«jums.`);
              return;
            }
            if (!CFG.readingRegex.test(consNorm)) {
              reasons.push(`SkaitÄ«tÄjs ${idx+1}: patÄ“riÅ†am jÄbÅ«t skaitlim (lÄ«dz 2 zÄ«mÄ“m aiz komata).`);
              return;
            }
          }

          if (!ln.reading) reasons.push(`SkaitÄ«tÄjs ${idx+1}: ievade nav korekta.`);
        });
      }

      return reasons;
    }

    // manual
    const blocks = $$(".address-block", $("#addresses"));
    if (blocks.length < 1) reasons.push("Nav pievienota neviena adrese.");

    blocks.forEach((block, ai) => {
      const addr = ($("input[data-role='addressText']", block).value || "").trim();
      if (!addr) reasons.push(`Adrese ${ai+1}: nav ievadÄ«ta adrese.`);
    });

    const lines = buildLinesManual().filter(x => x.adrese || x.skaititaja_numurs || x.radijums_raw);
    if (!lines.length) reasons.push("Nav ievadÄ«ts neviens skaitÄ«tÄjs.");

    lines.forEach((ln, idx) => {
      if (!ln.adrese) return;
      if (!CFG.meterNrRegex.test(ln.skaititaja_numurs)) reasons.push(`SkaitÄ«tÄjs ${idx+1}: Nr jÄbÅ«t tikai cipariem.`);
      const rNorm = normalizeReadingInput(ln.radijums_raw);
      if (!CFG.readingRegex.test(rNorm)) reasons.push(`SkaitÄ«tÄjs ${idx+1}: rÄdÄ«jumam jÄbÅ«t skaitlim (lÄ«dz 2 zÄ«mÄ“m aiz komata).`);
    });

    return reasons;
  }

  function updateSubmitState() {
    const reasons = getBlockingReasons();
    const ok = reasons.length === 0;

    const btn = $("#submitBtn");
    btn.classList.toggle("disabled", !ok);
    btn.setAttribute("aria-disabled", ok ? "false" : "true");

    if (ok) {
      $("#submitInfo").classList.remove("show");
      $("#submitInfo").innerHTML = "";
    }
  }

  function showSubmitBlockedInfo() {
    const reasons = getBlockingReasons();
    const box = $("#submitInfo");
    if (!reasons.length) { box.classList.remove("show"); box.innerHTML=""; return; }

    box.innerHTML =
      "<b>KÄpÄ“c poga IESNIEGT ir neaktÄ«va:</b><ul style='margin:8px 0 0 18px; padding:0;'>" +
      reasons.map(r => `<li>${escapeHtml(r)}</li>`).join("") +
      "</ul>";
    box.classList.add("show");
  }

  function switchToManual(){
    MODE = "manual";
    LOOKUP_FOUND = false;
    LOOKUP_LOADING = false;
    setLookupNotice(null, "");
    clearAuto();
    $("#manualSection").style.display = "block";
    initAddresses();
    refreshAll();
    $("#manualSection").scrollIntoView({ behavior:"smooth", block:"start" });
  }

  async function submit() {
    updateSubmitState();
    const btn = $("#submitBtn");
    if (btn.classList.contains("disabled")) { showSubmitBlockedInfo(); return; }

    btn.classList.add("disabled");
    btn.setAttribute("aria-disabled", "true");

    const KEY = "client_submission_id_current";
    let cid = sessionStorage.getItem(KEY);
    if (!cid) {
      cid = (crypto && crypto.randomUUID) ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2);
      sessionStorage.setItem(KEY, cid);
    }

    modalStateSending();

    const abon = readAbonentaKods();
    const contract = readContractNr();

    let payload = null;

    if (MODE === "lookup") {
      payload = {
        mode: "lookup",
        abonenta_numurs: abon,
        contract_nr: contract,
        lines: buildLinesLookup().map(x => ({ meter_no: x.meter_no, contract_nr: x.contract_nr, reading: x.reading })),
        website: "",
        client_submission_id: cid
      };
    } else {
      payload = {
        mode: "manual",
        abonenta_numurs: abon,
        lines: buildLinesManual().filter(x => x.adrese || x.skaititaja_numurs || x.radijums_raw).map(x => ({
          adrese: x.adrese,
          skaititaja_numurs: x.skaititaja_numurs,
          radijums: normalizeReadingInput(x.radijums_raw)
        })),
        website: "",
        client_submission_id: cid
      };
    }

    try {
      const res = await fetch("/api/submit", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });
      const j = await res.json().catch(()=>null);

      if (!res.ok || !j || j.ok !== true) {
        modalStateError((j && j.error) ? j.error : "NeizdevÄs nosÅ«tÄ«t.");
        btn.classList.remove("disabled");
        btn.setAttribute("aria-disabled", "false");
        return;
      }

      sessionStorage.removeItem(KEY);
      modalStateSuccess();
    } catch {
      modalStateError("Savienojuma problÄ“ma. LÅ«dzu, mÄ“Ä£ini vÄ“lreiz.");
      btn.classList.remove("disabled");
      btn.setAttribute("aria-disabled", "false");
    }
  }

  function refreshAll(){ updateSubmitState(); }

  function resetFormAll(){
    $$("#abonentaCodeBoxes input").forEach(i => i.value="");
    $("#contractNr").value = "";

    MODE = "lookup";
    LOOKUP_FOUND = false;
    LOOKUP_LOADING = false;
    LOOKUP_ATTEMPTED = false;

    setLookupNotice(null, "");
    clearAuto();

    $("#manualSection").style.display = "none";
    $("#addresses").innerHTML = "";
    refreshAll();
  }

  function init(){
    initCodeBoxes();
    refreshWindowNotice();
    setLookupNotice(null, "");

    $("#contractNr").addEventListener("input", () => {
      if (MODE === "lookup") {
        LOOKUP_FOUND = false;
        LOOKUP_ATTEMPTED = false;
        LOOKUP_LOADING = false;
        setLookupNotice(null, "");
        clearAuto();
      }
      refreshAll();
    });

    $("#contractNr").addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        $("#lookupBtn").click();
      }
    });

    $("#lookupBtn").addEventListener("click", () => runLookup());

    $("#addAddressBtn").addEventListener("click", () => {
      $("#addresses").appendChild(createAddressBlock());
      renumberAddresses();
      refreshAll();
    });

    $("#submitBtn").addEventListener("click", () => {
      if ($("#submitBtn").classList.contains("disabled")) showSubmitBlockedInfo();
      else submit();
    });

    refreshAll();
  }

  init();
</script>
</body>
</html>
